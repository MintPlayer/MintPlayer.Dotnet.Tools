using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;
using System.CodeDom.Compiler;
using System.Diagnostics;
using System.IO;
using System.Text;
using System.Threading;

namespace MintPlayer.SourceGenerators.Tools
{
    public abstract class Producer
    {
        protected Producer(string rootNamespace)
        {
            RootNamespace = rootNamespace;
        }

        public const string Header = """
            //-----------------------------------------------------------------------------------//
            // <auto-generated>                                                                  //
            //    This code was generated from source generator.                                 //
            //                                                                                   //
            //    Manual changes to this file may cause unexpected behavior in your application. //
            //    Manual changes to this file will be overwritten if the code is regenerated.    //
            // </auto-generated>                                                                 //
            //-----------------------------------------------------------------------------------//
            """;

        public string RootNamespace { get; }

        protected abstract ProducedSource? ProduceSource(IndentedTextWriter writer, CancellationToken cancellationToken);

        public void Produce(SourceProductionContext context)
        {
            context.CancellationToken.ThrowIfCancellationRequested();

            using var stringWriter = new StringWriter();
            using var indentedWriter = new IndentedTextWriter(stringWriter, "\t");

            var result = ProduceSource(indentedWriter, context.CancellationToken);
            if (result is { FileName: not null } producedSource)
            {
                if (producedSource.FileName == "FieldNameList.g.cs") Debugger.Break();
                if (producedSource.FileName == "ClassNames.g.cs") Debugger.Break();
                if (producedSource.FileName == "ClassNameList.g.cs") Debugger.Break();

                var code = stringWriter.ToString();
                context.AddSource(producedSource.FileName, SourceText.From(code, Encoding.UTF8));
            }
        }
    }
}